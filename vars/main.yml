---
# vars file for ap-application-load-balancer
alb_version: "v0.8.1-alpha"
alb_version_lastrun: -1

### ALB Internal Variables: Mixed usage ________________________________________

# alb_trusted_ips: "{% set myList = [1,5,3,4,2] %}"
# alb_trusted_ips: "{{ alb_dmz | default([]) + alb_bastion_hosts | default([]) + alb_jump_boxes | default([])}}"
alb_trusted_hosts: "{{ alb_dmz + alb_bastion_hosts }}"
alb_trusted_hosts_ips: "{{ alb_trusted_hosts | map(attribute='ip') | list }}"

alb_openresty_x_served_by_enabled: yes
alb_openresty_stub_status: "{{ alb_forcedebug }}"
alb_openresty_stub_status_location: "/openresty_status"

### ALB Internal Variables: Component HAProxy __________________________________

# This variable is used to calculate if we really can enable HAProxy Stats on this host
alb_haproxy_stats_safetoenable: "{{ alb_haproxy_stats_enabled is defined and alb_haproxy_stats_enabled is sameas true }}"
alb_haproxy_stats_authcredentials: "{{ alb_auth_users }}"
alb_haproxy_stats_realm_escaped: "{{ alb_haproxy_stats_realm | regex_replace(' ', '\\ ') }}" # HAproxy requires escape " " with "\ "
# alb_haproxy_stats_realm: "{{ alb_haproxy_stats_realm | regex_replace(' ', '\\\\_') }}" # HAproxy requires escape " " with "\ "
# alb_haproxy_stats_realm: "{{ alb_haproxy_stats_realm.split(' ').join('\ ') }}" # HAproxy requires escape " " with "\ "
# alb_haproxy_stats_realm: "{{ alb_haproxy_stats_realm | split(' ') | join('\ ') }}" # HAproxy requires escape " " with "\ "


nlb_listen_all: "{{ }}"

nlb_listen_openresty_safetoenable: yes
nlb_listen_redis_safetoenable: no
nlb_listen_http_safetoenable: yes

## https://www.haproxy.com/blog/the-four-essential-sections-of-an-haproxy-configuration/
nlb_redis:
  frontend:
    name: "frontend_redis"
    bind:
      - 127.0.0.1:6380 name redis
    default_backend: "backend_redis"
  backend:
    name: "backend_redis"
    auth: "{{ redis_password | default('')}}"
    option: "tcp-check"
    timeout_client: 120s
    timeout_server: 120s
    # TODO: change server to more flexible values (fititnt, 2019-11-25 13:06 BRT)
    server:
      - delta 173.249.10.99:6379 check inter 5s
      - echo 167.86.127.220:6379 check inter 5s
      - foxtrot 167.86.127.225:6379 check inter 5s

nlb_http:
  frontend:
    name: "frontend_http"
    bind:
      - "*:80"
    default_backend: "backend_http"
  backend:
    name: "backend_http"
    mode: "tcp"
    balance: "roundrobin"
    server:
      - "{{ inventory_hostname_short }} {{ alb_openresty_ip }}:{{ alb_openresty_httpport }} check inter 5s"
      #- delta 173.249.10.99:8080 check inter 5s
      #- echo 167.86.127.220:8080 check inter 5s
      #- foxtrot 167.86.127.225:8080 check inter 5s

### ALB Internal Variables: Facts ______________________________________________

# This result will be stored at /etc/ansible/facts.d/alb_apps.fact
alb_apps_facts:
  alb_apps: "{{ alb_apps | default(None) }}"

# This result will be stored at /etc/ansible/facts.d/alb_sysapps.fact
alb_sysapps_facts:
  alb_apps: "{{ alb_sysapps | default(None) }}"

alb_openresty_facts:
  ip: "{{ alb_openresty_ip }}"
  httpport: "{{ alb_openresty_httpport }}"
  httpsport: "{{ alb_openresty_httpsport }}"
  haproxy_ip : "{{ alb_haproxy_ip }}"
  haproxy_httpport: "{{ alb_haproxy_httpport }}"
  haproxy_httpsport: "{{ alb_haproxy_httpsport }}"

# This result will be stored at /etc/ansible/facts.d/alb_ufw.fact
#alb_common_facts:
#  common_tasks:
#    - "install aptitude"
#    - "hostnamectl set-hostname inventory_hostname_short"
#    - "timedatectl set-timezone UTC"
#    - "mkdir -p /etc/ansible/facts.d/"

alb_haproxy_facts:
  ip: "{{ alb_haproxy_ip }}"
  httpport: "{{ alb_haproxy_httpport }}"
  httpsport: "{{ alb_haproxy_httpsport }}"
  stats_enabled: "{{ alb_haproxy_stats_enabled }}"
  stats_safetoenable: "{{ alb_haproxy_stats_safetoenable }}"
  stats_trusted_hosts_only: "{{ alb_haproxy_stats_trusted_hosts_only }}"
  stats_trusted_hosts_skip_auth_check: "{{ alb_haproxy_stats_trusted_hosts_skip_auth_check }}" # To be implemented (fititnt, 2019-11-23 11:36 BRT)
  stats_ip: "{{ alb_haproxy_stats_ip }}"
  stats_port: "{{ alb_haproxy_stats_port }}"
  stats_uri: "{{ alb_haproxy_stats_uri }}"
  stats_realm: "{{ alb_haproxy_stats_realm }}"
  trusted_hosts_ips: "{{ alb_trusted_hosts_ips }}"
  openresty_ip: "{{ alb_openresty_ip }}"
  openresty_httpport: "{{ alb_openresty_httpport }}"
  openresty_httpsport: "{{ alb_openresty_httpsport }}"

# This result will be stored at /etc/ansible/facts.d/alb_ufw.fact
alb_lastrun_facts:
  alb_version: "{{ alb_version }}"
  alb_date_time: "{{ ansible_date_time.iso8601 }}"
  alb_manange:
    alb_manange_all: "{{ alb_manange_all | default(None) }}"
    alb_manange_haproxy: "{{ alb_manange_haproxy | default(None) }}"
    alb_manange_openresty: "{{ alb_manange_openresty | default(None) }}"
    alb_manange_common: "{{ alb_manange_common | default(None) }}"
    alb_manange_sanitycheck: "{{ alb_manange_sanitycheck | default(None) }}"
    alb_manange_apps: "{{ alb_manange_sanitycheck | default(None) }}"
    alb_manange_logrotate: "{{ alb_manange_sanitycheck | default(None) }}"


  # This result will be stored at /etc/ansible/facts.d/alb_ufw.fact
alb_ufw_facts:
  rules: "{{ alb_ufw_rules | default(None) }}"
  rules_always: "{{ alb_ufw_rules_always | default(None) }}"
  dmz: "{{ alb_dmz | default(None) }}"
  bastion_hosts: "{{ alb_bastion_hosts | default(None) }}"
  jump_boxes: "{{ alb_jump_boxes | default(None) }}"
  autoapply_dmz: "{{ alb_ufw_autoapply_dmz | default(None) }}"
  autoapply_bastion_hosts: "{{ alb_ufw_autoapply_bastion_hosts | default(None) }}"
  autoapply_jump_boxes: "{{ alb_ufw_autoapply_jump_boxes | default(None) }}"