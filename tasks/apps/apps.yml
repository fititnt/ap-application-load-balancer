---

# FILE:            {{ role_path }}/tasks/apps.yml
# LICENSE:         Public Domain

## NGinx Server Blocks (e.g. ~Apache Virtual Hosts)
#- name: "NGinx Server Blocks (e.g. ~Apache Virtual Hosts)"
#  template:
#    src: "{{ item.vhost_template|default(alb_apps_serverblock_template) }}"
#    dest: "/usr/local/openresty/nginx/conf/sites-enabled/{{ item.domain }}.conf"
#    owner: root
#    group: "root"
#    mode: 0644
#    backup: yes
#  with_items: "{{ alb_apps }}"
#  notify: reload openresty

- name: "Apps | ALB App Rules"
  template:
    # src: "{{ item.vhost_template|default(alb_apps_serverblock_template) }}"
    src: "{{ role_path }}/templates/alb-strategy/{{ item.app_alb_strategy | default(alb_default_app_alb_strategy) }}.conf.j2"
    dest: "/opt/alb/apps/{{ item.app_uid }}.conf"
    owner: root
    group: "root"
    mode: 0644
    backup: yes
  with_items: "{{ alb_apps }}"
  when: alb_apps is defined and alb_apps[0] is defined
  notify: reload openresty

- name: Apps | mkdir /var/log/app/[app_uid]
  file:
    path: /var/log/app/{{ item.app_uid }}
    state: directory
    mode: '0644'
    owner: root
  with_items: "{{ alb_apps }}"
  when: alb_apps is defined and alb_apps[0] is defined

- name: Apps | mkdir /var/log/app/[app_uid]/access.log
  file:
    path: /var/log/app/{{ item.app_uid }}/access.log
    state: touch
    mode: '0644'
    owner: www-data
    group: www-data
  with_items: "{{ alb_apps }}"
  when: alb_apps is defined and alb_apps[0] is defined

- name: Apps | mkdir /var/log/app/[app_uid]/error.log
  file:
    path: /var/log/app/{{ item.app_uid }}/error.log
    state: touch
    mode: '0644'
    owner: www-data
    group: www-data
  with_items: "{{ alb_apps }}"
  when: alb_apps is defined and alb_apps[0] is defined