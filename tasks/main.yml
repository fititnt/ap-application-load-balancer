---

# FILE:            {{ role_path }}/tasks/main.yml
# LICENSE:         Public Domain

- name: "ALB version {{ alb_version }}"
  debug: 
    msg: "{{ alb_version }}"

- name: "alb_trusted_hosts"
  debug: 
    msg: "{{ alb_trusted_hosts }}"

- name: "alb_trusted_hosts_ips"
  debug: 
    msg: "{{ alb_trusted_hosts_ips }}"

- name: check the version of last run on /etc/ansible/facts.d/alb_lastrun.fact
  set_fact:
    alb_version_lastrun: "{{ ansible_facts['ansible_local']['alb_lastrun']['alb_version'] }}"
  when: ansible_facts['ansible_local'] is defined and ansible_facts['ansible_local']['alb_lastrun'] is defined and ansible_facts['ansible_local']['alb_lastrun']['alb_version'] is defined

- name: "sanitycheck/main.yml"
  include: sanitycheck/main.yml
  tags:
    - alb
    - alb-sanitycheck
  when:
    - alb_manange_all is sameas true
    - alb_manange_sanitycheck is sameas true

- name: "common/common.yml"
  include: common/common.yml
  tags:
    - alb
    - alb-common
  when:
    - alb_manange_all is sameas true
    - alb_manange_common is sameas true

## NOTICE: this file is temporary (maybe permanent) disabled, see
##         https://github.com/fititnt/ap-application-load-balancer/issues/8#issuecomment-555401930
##         (fititnt, 2019-11-19 08:17 BRT)
#- name: alb-vars.yml (temporary file, will be replaced later)
#  include: alb-vars.yml
#  tags:
#    - alb
#    - alb-init
#    - alb-vars
#  when:
#    - alb_manange_all is sameas true
#    - alb_manange_apps is sameas true

- name: alb-init.yml
  include: alb-init.yml
  tags:
    - alb
    - alb-init
  when:
    - alb_manange_all is sameas true
    - alb_manange_apps is sameas true

- name: Instalação de OpenResty, Lua Rest & Lua Resty AutoSSL (faz o HTTPS para os Apps)
  include: openresty/openresty-luarocks-lua-resty-auto-ssl-install.yml
  tags:
    - alb
    - alb-openresty
  when:
    - alb_manange_all is sameas true
    - alb_manange_openresty is sameas true

- name: openresty/alb-openresty-after.yml
  include: openresty/alb-openresty-after.yml
  tags:
    - alb
    - alb-openresty
  when:
    - alb_manange_all is sameas true
    - alb_manange_openresty is sameas true

- name: HAproxy
  include: haproxy/haproxy.yml
  tags:
    - alb
    - alb-haproxy
  when:
    - alb_manange_all is sameas true
    - alb_manange_haproxy is sameas true
    - alb_forceignore_haproxy is defined and alb_forceignore_haproxy != true

- name: ALB rule for each App
  include: apps/apps.yml
  tags:
    - alb
    - alb-apps
  when:
    - alb_manange_all is sameas true
    - alb_manange_apps is sameas true

- name: logrotate/logrotate.yml
  include: logrotate/logrotate.yml
  tags:
    - alb
    - alb-logrotate
  when:
    - alb_manange_all is sameas true
    - alb_manange_logrotate is sameas true

# ansible-playbook -i hosts myplaybook.yml --tags "alb-ufw"
- name: ufw/main.yml
  include: ufw/main.yml
  tags:
    - alb
    - alb-ufw
    - alb-firewall
  # when: alb_forceignore_ufw is defined and alb_forceignore_haproxy != true
  when:
    - alb_manange_all is sameas true
    - alb_manange_ufw is sameas true

- name: alb-final.yml
  include: alb-final.yml
  tags:
    - alb
    - alb-final
  when:
    - alb_manange_all is sameas true