# {{ ansible_managed }}
#
# Minio
# https://docs.min.io/docs/setup-nginx-proxy-with-minio.html
server {
    # listen 443 ssl;
    listen {{ alb_openresty_httpsport }} ssl;
    server_name {{ item.app_domain | default(alb_default_app_domain) }};

    error_log  /var/log/app/{{ item.app_uid }}/error.log;
    access_log  /var/log/app/{{ item.app_uid }}/access.log  main;

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    {{ alb_apprule_automatichttps_httpsblock }}

    location / {
        # MIME type determined by default_type:
        default_type 'text/plain';

        content_by_lua_block {
            ngx.say('Hello, world, {{ item.app_uid }}!')
        }
    }
}

server {
    # listen 80;
    listen {{ alb_openresty_httpport }};

    server_name {{ item.app_domain | default(alb_default_app_domain) }};

    error_log  /var/log/app/{{ item.app_uid }}/error.log;
    access_log  /var/log/app/{{ item.app_uid }}/access.log  main;

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

{% if (item.app_forcehttps is defined and item.app_forcehttps is sameas true) or (item.app_forcehttps is undefined and alb_default_app_forcehttps is sameas true) %}
    ## item.app_forcehttps: true
    ## redirect 301 except for Let's Encrypt HTTPS check.
    location / {
        return 301 https://{{ item.app_domain | default(alb_default_app_domain) }}$request_uri;
    }
{% else %}
#### HTTPS redirect not enforced, allow HTTP block serve content - START

    location /lua_content {
        # MIME type determined by default_type:
        default_type 'text/plain';

        content_by_lua_block {
            ngx.say('Hello, world, {{ item.app_uid }}!')
        }
    }

#### HTTPS redirect not enforced, allow HTTP block serve content - END
{% endif %}

    {{ alb_apprule_automatichttp_httpsblock }}
}